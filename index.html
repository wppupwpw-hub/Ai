<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعدك الصوتي بالذكاء الاصطناعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #1A202C 0%, #0c1524 100%);
            min-height: 100vh;
            color: #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 8rem;
        }
        .ai-message-box {
            background-color: rgba(45, 55, 72, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            padding: 1.5rem;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            margin-bottom: 2rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .ai-message-box.show {
            opacity: 1;
            transform: translate(-50%, -50%) translateY(0);
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            position: absolute;
            bottom: 3rem;
        }
        .icon-button {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .icon-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .icon-button.pulse-animation {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
            }
        }
        .language-container {
            position: absolute;
            top: 2rem;
            right: 2rem;
        }
        .language-button {
            background-color: rgba(45, 55, 72, 0.8);
            backdrop-filter: blur(10px);
            color: #E2E8F0;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
        }
        .language-button:hover {
            background-color: rgba(74, 85, 104, 0.8);
        }
        .language-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            z-index: 10;
            display: none;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 120px;
        }
        .language-dropdown button {
            text-align: right;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .language-dropdown button:hover {
            background-color: rgba(74, 85, 104, 0.8);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Language Switch Dropdown -->
        <div class="language-container">
            <button id="lang-dropdown-button" class="language-button">العربية</button>
            <div id="lang-dropdown-menu" class="language-dropdown">
                <button data-lang="ar">العربية</button>
                <button data-lang="en">English</button>
                <button data-lang="zh">中文</button>
            </div>
        </div>

        <!-- AI Message Box -->
        <div id="ai-message-box" class="ai-message-box">
            <p id="ai-message-text" class="text-xl font-medium">مرحباً! أنا جاهز لمساعدتك.</p>
        </div>

        <!-- Buttons at the bottom -->
        <div class="action-buttons">
            <!-- Left Button -->
            <button id="left-button" class="icon-button bg-gray-600 text-white hidden">
                <i class="fas fa-pause w-8 h-8"></i>
            </button>
            
            <!-- Center AI Button -->
            <button id="ai-button" class="icon-button bg-blue-600 text-white">
                <i class="fa-solid fa-brain w-12 h-12"></i>
            </button>
            
            <!-- Right Button -->
            <button id="right-button" class="icon-button bg-gray-600 text-white hidden">
                <i class="fas fa-times w-8 h-8"></i>
            </button>
        </div>
    </div>

    <script>
        // A helper function to display a custom message with animation
        const messages = {
            'ar': {
                'initial': 'مرحباً! أنا جاهز لمساعدتك.',
                'listening': 'جاري الاستماع...',
                'analyzing': 'جاري تحليل كلامك',
                'response_ready': 'الرد جاهز.',
                'speech_unsupported': 'التعرف على الكلام غير مدعوم في متصفحك.',
                'rec_paused': 'تم إيقاف التسجيل.',
                'no_speech': 'لم يتم اكتشاف كلام.',
                'rec_error': 'حدث خطأ. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.',
                'mic_denied': 'تم رفض إذن الوصول إلى الميكروفون.',
                'audio_paused': 'تم إيقاف الصوت مؤقتاً.',
                'audio_cancelled': 'تم إلغاء الصوت.'
            },
            'en': {
                'initial': 'Hello! I am ready to assist you.',
                'listening': 'Listening...',
                'analyzing': 'Analyzing your speech',
                'response_ready': 'Response is ready.',
                'speech_unsupported': 'Speech recognition is not supported in your browser.',
                'rec_paused': 'Recording stopped.',
                'no_speech': 'No speech was detected.',
                'rec_error': 'An error occurred. Please check your internet connection and try again.',
                'mic_denied': 'Microphone access permission was denied.',
                'audio_paused': 'Audio paused.',
                'audio_cancelled': 'Audio cancelled.'
            },
            'zh': {
                'initial': '你好！我已准备好为您提供帮助。',
                'listening': '正在听...',
                'analyzing': '正在分析您的语音',
                'response_ready': '回复已准备好。',
                'speech_unsupported': '您的浏览器不支持语音识别。',
                'rec_paused': '录音已停止。',
                'no_speech': '未检测到任何语音。',
                'rec_error': '发生了一个错误。请检查您的网络连接并重试。',
                'mic_denied': '麦克风访问权限被拒绝。',
                'audio_paused': '音频已暂停。',
                'audio_cancelled': '音频已取消。'
            }
        };
        const langConfig = {
            'ar': { code: 'ar-SA', dir: 'rtl', text: 'العربية', voice: 'Iapetus' },
            'en': { code: 'en-US', dir: 'ltr', text: 'English', voice: 'Enceladus' },
            'zh': { code: 'zh-CN', dir: 'ltr', text: '中文', voice: 'Puck' }
        };

        let currentLang = 'ar';
        const langDropdownButton = document.getElementById('lang-dropdown-button');
        const langDropdownMenu = document.getElementById('lang-dropdown-menu');
        const aiMessageText = document.getElementById('ai-message-text');

        function showMessage(messageKey) {
            const message = messages[currentLang][messageKey];
            const aiMessageBox = document.getElementById('ai-message-box');
            aiMessageBox.classList.remove('show');
            setTimeout(() => {
                aiMessageText.textContent = message;
                aiMessageBox.classList.add('show');
            }, 500);
        }
        
        langDropdownButton.addEventListener('click', () => {
            langDropdownMenu.style.display = langDropdownMenu.style.display === 'flex' ? 'none' : 'flex';
        });

        langDropdownMenu.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', () => {
                const newLang = button.dataset.lang;
                if (newLang !== currentLang) {
                    currentLang = newLang;
                    updateLang();
                }
                langDropdownMenu.style.display = 'none';
            });
        });

        // A helper function to convert PCM to WAV
        function pcmToWav(pcm16Data, sampleRate) {
            const dataLength = pcm16Data.length * 2;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            let offset = 0;
            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset++, str.charCodeAt(i));
                }
            }
            function writeUint32(val) {
                view.setUint32(offset, val, true);
                offset += 4;
            }
            function writeUint16(val) {
                view.setUint16(offset, val, true);
                offset += 2;
            }
            writeString('RIFF');
            writeUint32(36 + dataLength);
            writeString('WAVE');
            writeString('fmt ');
            writeUint32(16);
            writeUint16(1);
            writeUint16(1); // Mono
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2);
            writeUint16(2);
            writeUint16(16);
            writeString('data');
            writeUint32(dataLength);
            const pcmView = new Int16Array(buffer, 44);
            pcmView.set(pcm16Data);
            return new Blob([view], { type: 'audio/wav' });
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        window.onload = function() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                const aiButton = document.getElementById('ai-button');
                aiButton.disabled = true;
                showMessage('speech_unsupported');
                return;
            }

            const aiButton = document.getElementById('ai-button');
            const leftButton = document.getElementById('left-button');
            const rightButton = document.getElementById('right-button');
            
            const recognition = new SpeechRecognition();
            
            let currentAudio = null;
            let currentTranscript = '';

            const updateLang = () => {
                const htmlTag = document.documentElement;
                const config = langConfig[currentLang];
                htmlTag.setAttribute('lang', config.code);
                htmlTag.setAttribute('dir', config.dir);
                langDropdownButton.textContent = config.text;
                recognition.lang = config.code;
                showMessage('initial');
            };

            updateLang();

            recognition.interimResults = false;
            recognition.continuous = false;

            let isRecording = false;

            aiButton.addEventListener('click', () => {
                if (!isRecording) {
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio.currentTime = 0;
                    }
                    try {
                        recognition.start();
                        isRecording = true;
                        aiButton.classList.remove('bg-blue-600');
                        aiButton.classList.add('bg-red-600', 'pulse-animation');
                        leftButton.classList.remove('hidden');
                        rightButton.classList.remove('hidden');
                        showMessage('listening');
                        currentTranscript = '';
                    } catch (error) {
                        console.error('Error starting recognition:', error);
                        showMessage('rec_error');
                    }
                } else {
                    recognition.stop();
                    isRecording = false;
                    aiButton.classList.remove('bg-red-600', 'pulse-animation');
                    aiButton.classList.add('bg-blue-600');
                    leftButton.classList.add('hidden');
                    rightButton.classList.add('hidden');
                    showMessage('rec_paused');
                }
            });

            leftButton.addEventListener('click', () => {
                if (currentAudio) {
                    currentAudio.pause();
                }
                showMessage('audio_paused');
            });

            rightButton.addEventListener('click', () => {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio = null;
                }
                showMessage('audio_cancelled');
            });

            recognition.onresult = (event) => {
                currentTranscript = event.results[0][0].transcript;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                let errorMessageKey = 'rec_error';
                if (event.error === 'no-speech') {
                    errorMessageKey = 'no_speech';
                } else if (event.error === 'not-allowed') {
                    errorMessageKey = 'mic_denied';
                }
                showMessage(errorMessageKey);
                isRecording = false;
                aiButton.classList.remove('bg-red-600', 'pulse-animation');
                aiButton.classList.add('bg-blue-600');
                leftButton.classList.add('hidden');
                rightButton.classList.add('hidden');
            };
            
            recognition.onend = () => {
                isRecording = false;
                aiButton.classList.remove('bg-red-600', 'pulse-animation');
                aiButton.classList.add('bg-blue-600');
                leftButton.classList.add('hidden');
                rightButton.classList.add('hidden');
                if (currentTranscript.trim() !== '') {
                    sendToAPI(currentTranscript, currentLang);
                } else {
                    showMessage('no_speech');
                }
            };
            
            async function sendToAPI(textToSend, lang) {
                showMessage('analyzing');
                try {
                    // Call the Netlify function to get the API key
                    const apiKeyResponse = await fetch('/.netlify/functions/get-api-key');
                    if (!apiKeyResponse.ok) {
                        throw new Error('Failed to get API key from Netlify function.');
                    }
                    const apiKey = (await apiKeyResponse.json()).API_KEY;

                    // Part 1: Get text from Gemini
                    const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const textPayload = {
                        contents: [{
                            parts: [{ text: textToSend }]
                        }],
                    };
                    const textResponse = await fetch(textApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(textPayload)
                    });
                    if (!textResponse.ok) {
                        const errorData = await textResponse.json();
                        throw new Error(`API Error: ${textResponse.status} - ${JSON.stringify(errorData)}`);
                    }
                    const textResult = await textResponse.json();
                    let generatedText = '';
                    if (textResult && textResult.candidates && textResult.candidates.length > 0) {
                        generatedText = textResult.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('No valid text response received from AI.');
                    }
                    
                    // Part 2: Get audio from TTS model
                    const audioApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                    const audioPayload = {
                        contents: [{
                            parts: [{ text: generatedText }]
                        }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: langConfig[lang].voice }
                                }
                            }
                        },
                    };
                    const audioResponse = await fetch(audioApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(audioPayload)
                    });
                    if (!audioResponse.ok) {
                        const errorData = await audioResponse.json();
                        throw new Error(`Audio API Error: ${audioResponse.status} - ${JSON.stringify(errorData)}`);
                    }
                    const audioResult = await audioResponse.json();
                    let audioData = null;
                    let mimeType = null;
                    if (audioResult && audioResult.candidates && audioResult.candidates.length > 0) {
                        const audioPart = audioResult.candidates[0].content.parts.find(p => p.inlineData && p.inlineData.mimeType.startsWith('audio/'));
                        if (audioPart) {
                            audioData = audioPart.inlineData.data;
                            mimeType = audioPart.inlineData.mimeType;
                        }
                    } else {
                        throw new Error('No valid audio response received from AI.');
                    }
                    
                    if (audioData && mimeType) {
                        const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        currentAudio = new Audio(audioUrl);
                        currentAudio.play();
                        showMessage('response_ready');
                    } else {
                        throw new Error('لم يتم استلام رد صوتي صالح من الذكاء الاصطناعي.');
                    }
                } catch (error) {
                    console.error('Error fetching data from API:', error);
                    showMessage('rec_error');
                }
            }
        };
    </script>
</body>
</html>
